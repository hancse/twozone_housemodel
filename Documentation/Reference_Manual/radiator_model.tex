%\subsection{Radiator}
\subsubsection{Radiator}

Radiators are an essential part of the thermal building model. They are a special kind of heat exchanger which is completely immersed in its surroundings. In a radiator, the heat transport is in good approximation only due to \emph{convection} of a gas (steam) or liquid (water, glycol, brine). The elements of the radiator model are:

\begin{itemize}
	\item a "hot" node $T_{supply}$. This is a node of type \textsf{FixedNode} or \textsf{CapacityNode}(see section \ref{sec:capnode}).
	\item a "cold" node $T_{return}$. This is a node of type \textsf{FixedNode} (see section \ref{sec:fixnode}), with a variable temperature, but no heat capacity.
	\item an "ambient" temperature $T_{indoor}$ of the surroundings of the radiator \textit{i.e.} the interior of the building in the model.
	\item an "effective" temperature \emph{difference} $\Delta T_{LMTD}$ between the radiator and its surroundings. 
	\item a \textsf{Flow} object with a \textsf{node\_list} starting at the cold node, passing through \textit{e.g.} a buffer vessel, and ending, via the top layer of the vessel, at the hot node. There (part of) the thermal energy "disappears" from the flow to the building. The remaining thermal energy is returned to the bottom layer of the vessel. The flow object has an attribute $F_{rad}$ which equals the magnitude of the thermal heat transfer in $[W/K]$.
	\item the instantaneous thermal power $\dot{q}_{rad}$, delivered by the radiator to the interior of the building. Equals $F_{rad} \cdot (T_{supply} - T_{return})$.
\end{itemize} 

\begin{figure}[h!]
	\begin{center}
		\begin{circuitikz}[scale = 0.8]
			\ctikzset{bipoles/thickness=3}
			\draw (7.5,0)
			to [short] (7.5,8)
			to [short] (5,8)
			to [short] (5,5)
			to [short] (4,5)
			node[color=red, circ, label={[red]above:$T_{supply}$}]{}
			to [short, *-*] (4,3)
			node[color=blue, circ, label={[blue]above:$T_{return}$}]{}
			to [short] (5,3)
			to [short] (5,0)
			to [short] (7.5,0)
			(4,4) to[amp, label=$\dot{q}_{rad}$] ++(-4,0)
			node[color=red, circ, label={[red]above:$T_{indoor}$}]{};
			\draw (8,0)
			node[color=darkgreen, circ, label={[darkgreen]above:$T_{bottom}$}]{}
			to[R,R=$R_{mid,bot}$] (8,4) 
			node[color=darkgreen, circ, label={[darkgreen]above:$T_{mid}$}]{}
			to[R,R=$R_{top,mid}$, -*] (8,8)
			node[color=darkgreen, circ, label={[darkgreen]above:$T_{top}$}]{};
		\end{circuitikz}
		\caption{Radiator model}
		\label{fig:rad}
	\end{center}
\end{figure}

In Fig.~\ref{fig:rad} a radiator is shown with its nodes, surroundings and a buffer vessel for generating a supply and return flow. In the radiator, the heat transport is in good approximation only due to \emph{convection} of a gas (steam) or liquid (water, glycol, brine). For a liquid medium, the following equation holds:

\begin{equation}\color{blue}
	\label{eq:radnonlin}
	\begin{aligned}
		F_{rad} &= \dot{f} \cdot \rho \cdot c_w  &= \dot{m} \cdot c_w 
	\end{aligned}
\end{equation}

where: \\
$\rho$ is the density of the medium in $[kg/m^3]$ \\
$c_w$ is the specific heat capacity of water: $4.2 \cdot 10^3 J/(kg \cdot K)$ \\
$\dot{f}$ is the liquid volume flow in $[m^3/s]$ \\
$\dot{m}$ is the liquid mass flow in $[kg/s]$ \\

The \textsf{Radiator} class in Python encapsulates the attributes above and the calculation of $F_{rad}$. The methods of this class are:
\begin{itemize}
	\item \textsf{\_\_init\_\_}: initializes the class members. Members starting with \_\_* are private members.
\end{itemize}

\lstinputlisting[label=lst:Radiator, linerange={102-151}, 
caption={Radiator class}] 
{../../housemodel/sourcesink/radiators/radiators.py}

\begin{itemize}
	\item \textsf{from\_dict}. This method operates as an "overloaded" constructor, reading from a Python \textsf{dictionary}.
\end{itemize}

\lstinputlisting[label=lst:Radiator, linerange={153-157}, 
caption={Radiator class}] 
{../../housemodel/sourcesink/radiators/radiators.py}

\begin{itemize}
	\item \textsf{get\_gmtd} and \textsf{get\_lmtd}: return the value of private member \_\_gmtd or \_\_lmtd.
\end{itemize}

\lstinputlisting[label=lst:Radiator, linerange={175-179}, 
caption={Radiator class}] 
{../../housemodel/sourcesink/radiators/radiators.py}

The Radiator class uses helper functions \textsf{GMTD\_radiator} and \textsf{LMTD\_radiator} to determine the effective temperature difference:

\lstinputlisting[label=lst:lmtd, linerange={22-70}, 
caption={GMTD\_radiator and LMTD\_radiator helper functions}] 
{../../housemodel/sourcesink/radiators/radiators.py}


In the building model, a fluid flow through the radiator leads to the delivery of heat to the room(s). The equations for the heat transfer of the radiator are: 

{\color{blue}
	\begin{equation}
		\label{eq:radnonlin}
		\begin{aligned}
			\dot{q}_{rad} &- K_m \cdot (\Delta T_{LMTD})^n &= 0 \\
			\dot{q}_{rad} &- F_{rad} \cdot (T_{feed} - T_{return}) &= 0 \\ \\
			&\text{with } \Delta T_{LMTD} = \frac{T_{feed} - T_{return}}{\ln\left(\frac{T_{feed} -T_{air}}{T_{return} - T_{air}}\right)}
		\end{aligned}
	\end{equation}
}

This nonlinear system of equations can be solved for the two unknowns $[\dot{q}_{rad} \quad T_{return}]$, if input data $T_{supply}$, $ T_{ind}$, $C_{rad}$ and $F_{rad}$ are provided. A solver needs the function template in Eq.~\ref{eq:radnonlin}, with the unknowns vector as input variable. Furthermore, the Jacobian of the function template has to be calculated. Evaluation of an analytical expression of the partial derivatives in the Jacobian always outperforms numerical derivative calculations. Thus, for the upper equation (function) in set \ref{eq:radnonlin}:

\begin{equation}
	\begin{aligned}
		\begin{matrix}
			\frac{\partial f}{\partial \dot{Q}_{rad}} &= 1 \\ 
			\\
			\dfrac{\partial f}{\partial T_{return}} &= -Cn\cdot \dfrac{\left(\frac{T_1-T_2}{\ln\left(\frac{T_1-T_3}{T_2-T_3}\right)}\right)^{n-1}\,\left(\frac{T_1-T_2}{T_2-T_3}-\ln\left(\frac{T_1-T_3}{T_2-T_3}\right)\right)}{\ln^2\left(\frac{T_1-T_3}{T_2-T_3}\right)} \\ \\
		\end{matrix}
	\end{aligned}
\end{equation} 
for the second equation:
\begin{equation}
	\begin{aligned}
		\begin{matrix}
			\frac{\partial f}{\partial \dot{Q}_{rad}} &= 1 \\ \\
			\frac{\partial f}{\partial T_{return}} &= F_{rad}
		\end{matrix}
	\end{aligned}
\end{equation} 

See: \url{https://www.derivative-calculator.net/}.

The Jacobian matrix becomes:
\begin{equation}
	\begin{aligned}
		\mathbf{J}_{i,j}=\dfrac{\partial f_{i}(\mathbf{x})}{\partial x_{j}} =
		\begin{bmatrix}
			\dfrac{\partial f_1}{\partial \dot{Q}_{rad}} & \dfrac{\partial f_1}{\partial T_{return}} \\ 
			\vspace{2pt} \\
			\dfrac{\partial f_2}{\partial \dot{Q}_{rad}} & \dfrac{\partial f_2}{\partial T_{return}}
		\end{bmatrix}
		\qquad
		\mathbf{x} =
		\begin{bmatrix}
			\dot{q}_{rad} \\ 
			T_{return}
		\end{bmatrix}
	\end{aligned}
\end{equation} 

{\color{blue}
	\begin{equation}
		\label{eq:radgmtd}
		\begin{aligned}
			\dot{q}_{rad} &- K_m \cdot (\Delta T_{GMTD})^n &= 0 \\
			\dot{q}_{rad} &- F_{rad} \cdot (T_{s} - T_{r}) &= 0 \\ \\
			&\text{with } \Delta T_{GMTD} = \sqrt{\Delta T_{s,ind}} \cdot  \sqrt{(T_{return} - T_{ind}})
		\end{aligned}
	\end{equation}
}

This nonlinear system of equations can be solved for the two unknowns $[\dot{q}_{rad} \quad T_{r}]$, if input data $T_{a}$, $ T_{i}$, $K_m$ and $F_{rad}$ are provided. A solver needs the function template in Eq.~\ref{eq:radgmtd}, with the unknowns vector as input variable. Furthermore, the Jacobian of the function template has to be calculated. Evaluation of an analytical expression of the partial derivatives in the Jacobian always outperforms numerical derivative calculations. 

Note the left-hand side of the first equation can be written as:
$$ \dot{q}_{rad} - K_{m} \cdot \left(\Delta T_{s,ind}\right)^{n/2} \cdot \left(T_{return} - T_{ind}\right)^{n/2} $$

Thus, for the upper equation (function) in set \ref{eq:radgmtd}:

\begin{equation}
	\begin{aligned}
		\begin{matrix}
			\dfrac{\partial f}{\partial \dot{q}_{rad}} &= 1 \\ 
			\\
			\dfrac{\partial f}{\partial T_{return}} &= - K_{m} \cdot \left(\Delta T_{s,ind}\right)^{n/2} \cdot \dfrac{n}{2} \cdot \left(T_{return} - T_{ind}\right)^{(n/2)-1} \\ \\
		\end{matrix}
	\end{aligned}
\end{equation} 
for the second equation:
\begin{equation}
	\begin{aligned}
		\begin{matrix}
			\dfrac{\partial f}{\partial \dot{q}_{rad}} &= 1 \\ \\
			\dfrac{\partial f}{\partial T_{return}} &= F_{rad}
		\end{matrix}
	\end{aligned}
\end{equation} 

See: \url{https://www.derivative-calculator.net/}.

The Jacobian matrix becomes:
\begin{equation}
	\begin{aligned}
		\mathbf{J}_{i,j}=\dfrac{\partial f_{i}(\mathbf{x})}{\partial x_{j}} =
		\begin{bmatrix}
			\dfrac{\partial f_1}{\partial \dot{Q}_{rad}} & \dfrac{\partial f_1}{\partial T_{return}} \\ 
			\vspace{2pt} \\
			\dfrac{\partial f_2}{\partial \dot{Q}_{rad}} & \dfrac{\partial f_2}{\partial T_{return}}
		\end{bmatrix}
	    \qquad
	    \mathbf{x} =
	    \begin{bmatrix}
	    	\dot{q}_{rad} \\ 
	    	T_{return}
	    \end{bmatrix}
	\end{aligned}
\end{equation} 


\begin{itemize}
	\item \textsf{func\_rad}: calculates radiator equations and partial derivatives.
	\item \textsf{update}: uses \textsf{scipy.optimize.root()} to find the roots $\mathbf{x}$ of the radiator equations.
\end{itemize}

Other radiator models can be found in \cite{TolRadiator, TolThesis}.




The $\mathbf{DF_{demand}}$-matrix will remain symmetric, but will get extra contributions to the diagonal elements. It may be a good idea to split the $\mathbf{F}$-matrix into two parts, $\mathbf{F_{int}}$ and $\mathbf{F_{ext}}$. Thus, the thermal flow \emph{between} the \textsf{CapacityNodes} and from the \textsf{FixedNodes} to the \textsf{CapacityNodes} can be separately calculated.

\begin{itemize}
	\item AMTD = $\dfrac{T_{feed} - T_{ind} + (T_{return} - T_{ind})}{2} = 
	\dfrac{T_{feed} + T_{return} - 2 \cdot T_{ind})}{2}$.
	\item GMTD = $\sqrt{(T_{feed} - T_{ind})} \cdot  \sqrt{(T_{return} - T_{ind}})$.
	\item LMTD = $\dfrac{(T_{feed} - T_{ind}) - (T_{return} - T_{ind})}{\ln(T_{feed} - T_{ind}) -\ln(T_{return} - T_{ind})} = \dfrac{T_{feed} - T_{return}}{\ln(T_{feed} - T_{ind}) -\ln(T_{return} - T_{ind})}$.
\end{itemize}



\subsubsection{Phetteplace}

A radiator model which is used as  a general load for district heating systems is found in \cite{etde_6539997}:

\begin{equation}
	\begin{aligned}
		\dfrac{q_2}{q_0} = \left[\dfrac{\Delta T_{LMTD,1}}{\Delta T_{LMTD,0}}\right]^{n_1} \cdot \left[\dfrac{\Delta T_{LMTD,2}}{\Delta T_{LMTD,1}}\right]^{n_2}
	\end{aligned}
	\label{eq:Boehm}
\end{equation}

where $q$ = heat output from the radiator [W]

$T_{ml}$ = logarithmic mean temperature difference [$\degC$].

$n_1$, $n_2$ = empirically determined coefficients (dimensionless)

and the subscripts denote the following operating conditions:
\begin{itemize} %[label={}]
	\item[] 0 = "design" condition for the radiators
	\item[] 1 = condition of actual supply temperature with the flow rate as determined under the design condition
	\item[] 2 = any actual operating condition
\end{itemize}


In practice, and in the standard \cite{NEN442}, $n = n_1 = n_2$. This allows for dropping the indices  1 and reduce the expression \ref{eq:Boehm} to:

\begin{equation}
	\begin{aligned}
		\dfrac{q}{q_0} = \left[\dfrac{\Delta T_{LMTD}}{\Delta T_{LMTD,0}}\right]^{n}
	\end{aligned}
	\label{eq:Boehm442}
\end{equation}

Using the ratio of $\Delta T_{LMTD}$ values, only an implicit (iterative) solution is possible. From Ref.~\cite{} it is clear that approximation of $\Delta T_{LMTD}$ by $\Delta T_{AMTD}$ is not satisfactory. The approximation by $\Delta T_{GMTD}$ may be satisfactory for our application, so we use:

\begin{equation}
	\begin{aligned}
		\dfrac{q}{q_0} &= \left[\dfrac{\Delta T_{GMTD}}{\Delta T_{GMTD,0}}\right]^{n} = \left[\dfrac{\sqrt{(T_s - T_{i})} \cdot  \sqrt{(T_r - T_{i}})}{\Delta T_{GMTD,0}}\right]^{n} \\
		q &= \dot{m} c_p \cdot (T_s - T_r)
	\end{aligned}
	\label{eq:BoehmGMTD}
\end{equation}

Using:

$$ \Delta T_{s,ind} = T_s - T_i $$
$$ \Delta T_{r,ind} = T_r - T_i $$
$$ \Delta T_{s,r} = T_s - T_r $$

We can take the square of the expression for $\dfrac{q}{q_0}$  and subsequently take the n-th root: 

$$ \left(\dfrac{q_2}{q_0}\right)^2 = \left[\dfrac{(T_s - T_{i}) \cdot  (T_r - T_{i})}{\Delta T_{GMTD,0}^2}\right]^{n} $$
$$ \left(\dfrac{q_2}{q_0}\right)^{2/n} = \left[\dfrac{(T_s - T_{i}) \cdot  (T_r - T_{i})}{\Delta T_{GMTD,0}^2}\right] $$

to arrive at:

\begin{equation}
	\begin{aligned}
		T_{r} &= T_i + \left[\dfrac{\Delta T_{GMTD,0}^2}{\Delta T_{s,ind}} \cdot \left(\dfrac{q}{q_0}\right)^{2/n}\right] \\
		q &= \dot{m} c_p \cdot (T_s - T_r)
	\end{aligned}
	\label{eq:BoehmGMTD}
\end{equation}


In Eq~\ref{eq:BoehmGMTD}, $\Delta T_{GMTD,0}$ and $q_0$ are known, "design" quantities of the radiator. Moreover, $ \Delta T_{s,ind} = T_s - T_i $ is known from the current state of the house model. In contrast to the calculations of Phetteplace \cite{}, where $q$ is also given, we have \emph{two} unknowns $q$ and $T_r$:

\begin{equation}
	\begin{aligned}
		T_{r} &= T_i + \left[\dfrac{\Delta T_{GMTD,0}^2}{\Delta T_{s,ind}} \cdot \left(\dfrac{q}{q_0}\right)^{2/n}\right] \\
		q &= \dot{m} c_p \cdot (T_s - T_r) \\
		\\
		T_{r} &= T_s -\dfrac{q}{\dot{m} c_p}
	\end{aligned}
	\label{eq:PPGMTD}
\end{equation}

\begin{equation}
	\begin{aligned}
		T_s -\dfrac{q}{\dot{m_2} c_p} &= T_i + \left[\dfrac{\Delta T_{GMTD,0}^2}{\Delta T_{s,ind}} \cdot \left(\dfrac{q}{q_0}\right)^{2/n}\right] \\
		-\dfrac{q}{\dot{m_2} c_p} &= T_i - T_s + \left[\dfrac{\Delta T_{GMTD,0}^2}{\Delta T_{s,ind}} \cdot \left(\dfrac{q}{q_0}\right)^{2/n}\right]  \\
		\dfrac{q}{\dot{m_2} c_p} &= T_s - T_i - \left[\dfrac{\Delta T_{GMTD,0}^2}{\Delta T_{s,ind}} \cdot \left(\dfrac{q}{q_0}\right)^{2/n}\right]  \\
		\\
		\dfrac{q}{\dot{m_2} c_p} &= \Delta T_{s,ind} - \left[\dfrac{\Delta T_{GMTD,0}^2}{\Delta T_{s,ind}} \cdot \left(\dfrac{q}{q_0}\right)^{2/n}\right]  \\
	\end{aligned}
	\label{eq:PPGMTD}
\end{equation}

